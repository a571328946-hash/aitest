<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>批量文件重命名工具 (Pro)</title>
  <style>
    :root {
      /* 更现代的配色 */
      --primary: #3b82f6; 
      --primary-hover: #2563eb;
      --primary-light: #eff6ff;
      --bg: #f3f4f6;       /* 稍微深一点的背景 */
      --surface: #ffffff;
      --border: #e5e7eb;
      --text-main: #111827;
      --text-sub: #6b7280;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --radius: 16px;      /* 更圆润的角 */
      --font-sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }

    * { box-sizing: border-box; outline-color: var(--primary); }
    
    body {
      margin: 0;
      font-family: var(--font-sans);
      background-color: var(--bg);
      color: var(--text-main);
      line-height: 1.5;
      padding-bottom: 100px; /* 底部留空给固定栏 */
      height: 100vh;
      overflow-y: scroll;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 24px;
    }

    /* 头部 */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }
    .header h1 {
      font-size: 28px;
      font-weight: 800;
      color: var(--text-main);
      margin: 0;
      letter-spacing: -0.03em;
    }
    .badge {
      display: inline-flex; align-items: center; padding: 6px 14px;
      background: #dbeafe; color: #1e40af; border-radius: 99px;
      font-size: 13px; font-weight: 600;
      box-shadow: 0 2px 4px rgba(37,99,235,0.1);
    }
    .badge::before {
      content: ""; display: inline-block; width: 6px; height: 6px;
      background: currentColor; border-radius: 50%; margin-right: 8px;
    }

    /* 核心双栏布局 */
    .main-grid {
      display: grid;
      grid-template-columns: 380px 1fr; /* 左侧略宽一点 */
      gap: 24px;
      align-items: start;
    }
    @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }

    /* 卡片通用 */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      margin-bottom: 24px;
      transition: box-shadow 0.3s ease;
    }
    .card:hover { box-shadow: var(--shadow-md); }
    
    .card-head {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      font-weight: 700;
      background: #fff;
      font-size: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--text-main);
    }
    .card-head-sub { font-size: 13px; color: var(--text-sub); font-weight: 400; margin-left: 8px; }

    /* 列表头部的新增控件区 */
    .list-header-ctrls {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-left: auto;
    }
    
    .btn-xs {
      padding: 5px 12px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: white;
      color: #ef4444;
      font-size: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    .btn-xs:hover { background: #fef2f2; border-color: #fee2e2; }

    /* --- 左侧：规则设置区 --- */
    .rules-grid {
      display: flex;
      flex-direction: column;
      background: #f9fafb; /* 淡淡的底色区分 */
      padding: 8px;
      gap: 8px;
    }
    .rule-row {
      padding: 16px;
      background: #fff;
      border-radius: 12px;
      border: 1px solid transparent; /* 默认无边框 */
      display: flex;
      align-items: flex-start;
      gap: 14px;
      transition: all 0.2s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    }
    .rule-row:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.05); transform: translateY(-1px); }
    
    /* 激活状态 */
    .rule-row.active {
      background: #fff;
      border-color: #bfdbfe; /* 激活时边框变蓝 */
      box-shadow: 0 4px 12px rgba(59,130,246,0.1);
    }
    
    /* 开关 - iOS 风格 */
    .switch-wrap { padding-top: 2px; flex-shrink: 0; }
    .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #e5e7eb; transition: .3s; border-radius: 34px;
    }
    .slider:before {
      position: absolute; content: ""; height: 20px; width: 20px; left: 2px; bottom: 2px;
      background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(20px); }

    /* 规则内容 */
    .rule-content {
      flex: 1;
      opacity: 0.6;
      pointer-events: none;
      transition: opacity 0.3s;
      filter: grayscale(0.5); /* 未激活时稍微灰一点 */
    }
    .rule-row.active .rule-content {
      opacity: 1;
      pointer-events: auto;
      filter: grayscale(0);
    }
    
    .rule-title {
      font-weight: 700; font-size: 15px; margin-bottom: 10px; color: var(--text-main);
      display: flex; align-items: center; gap: 8px;
    }
    
    .ctrl-group { display: flex; flex-direction: column; gap: 10px; }
    .input-row { display: flex; align-items: center; gap: 8px; }
    
    /* 输入框美化 */
    input[type="text"], input[type="number"], select {
      padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 8px;
      font-size: 14px; outline: none; background: #f9fafb; width: 100%;
      color: var(--text-main);
      transition: all 0.2s;
    }
    input:focus, select:focus {
      background: #fff; border-color: var(--primary); 
      box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
    }
    input:disabled { background: #f3f4f6; color: #9ca3af; cursor: not-allowed; }
    
    .label-sm { font-size: 12px; color: var(--text-sub); white-space: nowrap; font-weight: 500; }

    /* --- 右侧：上传与列表 --- */
    .file-list-wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #fff;
      min-height: 500px; /* 增加最小高度 */
    }

    /* 上传区域 */
    .upload-compact {
      padding: 36px;
      text-align: center;
      cursor: default; 
      transition: all 0.3s;
      background: #fff;
      border-bottom: 1px dashed #e5e7eb;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }
    .upload-compact:hover { background: #f8fafc; }
    .upload-compact.drag-over { background: var(--primary-light); border-color: var(--primary); }
    .upload-compact.paste-success { background-color: #ecfdf5 !important; } /* 绿色成功反馈 */

    .upload-icon {
      width: 52px; height: 52px; color: #d1d5db;
      display: block; transition: color 0.3s;
    }
    .upload-compact:hover .upload-icon { color: var(--primary); }

    .btn-select {
      background: var(--primary); color: white; padding: 10px 24px;
      border-radius: 8px; font-weight: 600; border: none; cursor: pointer;
      font-size: 14px; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.25);
      display: inline-flex; align-items: center; gap: 8px;
    }
    .btn-select:hover { background: var(--primary-hover); transform: translateY(-1px); box-shadow: 0 6px 10px -1px rgba(59, 130, 246, 0.3); }
    .btn-select:active { transform: translateY(0); }
    .upload-hint { font-size: 13px; color: var(--text-sub); }

    /* 列表 */
    .preview-area {
      flex: 1;
      overflow-y: auto;
      max-height: 480px;
    }
    table { width: 100%; border-collapse: collapse; font-size: 14px; table-layout: fixed; }
    thead {
      position: sticky; top: 0; background: #f9fafb; z-index: 10;
      font-weight: 600; color: var(--text-sub); border-bottom: 1px solid #e5e7eb;
      font-size: 13px; text-transform: uppercase; letter-spacing: 0.05em;
    }
    th, td { padding: 14px 20px; border-bottom: 1px solid #f3f4f6; text-align: left; }
    tr:hover { background: #f8fafc; }
    
    .col-idx { width: 50px; text-align: center; color: var(--text-sub); font-size: 13px; }
    .col-old { width: 40%; color: var(--text-sub); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .col-arrow { width: 30px; text-align: center; color: #d1d5db; font-size: 16px; }
    .col-new { width: 40%; font-weight: 600; color: var(--text-main); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .col-status { width: 90px; text-align: right; }

    .tag { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 99px; font-size: 12px; font-weight: 600; line-height: 1.4; }
    .tag-ok { color: #065f46; background: #d1fae5; }
    .tag-err { color: #991b1b; background: #fee2e2; }
    .tag-dup { color: #92400e; background: #fef3c7; }
    .tag-wait { color: #6b7280; background: #f3f4f6; }

    /* 底部悬浮栏 */
    .bottom-bar {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(16px);
      border-top: 1px solid #e5e7eb;
      padding: 16px 32px;
      display: flex; justify-content: flex-end;
      align-items: center;
      gap: 16px;
      box-shadow: 0 -4px 24px rgba(0,0,0,0.06);
      z-index: 100;
    }
    .bar-right { display: flex; align-items: center; gap: 16px; }

    .btn-action {
      padding: 12px 28px; border-radius: 10px; font-weight: 600; cursor: pointer; border: 1px solid transparent; font-size: 15px;
      display: flex; align-items: center; gap: 8px; transition: all 0.2s;
    }
    .btn-apply {
      background: var(--text-main); color: white;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    }
    .btn-apply:hover:not(:disabled) { background: #000; transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    .btn-apply:disabled { opacity: 0.5; cursor: not-allowed; background: #9ca3af; box-shadow: none; }

    .btn-zip {
      background: var(--primary); color: white;
      box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.25);
    }
    .btn-zip:hover:not(:disabled) { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.35); }
    .btn-zip:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; background: #93c5fd; }

    /* 拖拽全屏覆盖 */
    .drag-cover {
      position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      border: 8px dashed var(--primary); color: var(--primary); font-size: 24px; font-weight: 700;
      opacity: 0; pointer-events: none; transition: opacity 0.2s;
      backdrop-filter: blur(4px);
    }
    .dragging .drag-cover { opacity: 1; pointer-events: auto; }

    /* 隐藏文件输入 */
    input[type="file"] { display: none; }
  </style>
</head>
<body id="body">

<div class="drag-cover">
  <svg width="80" height="80" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-bottom:20px"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
  松开鼠标添加文件
</div>

<div class="container">
  <div class="header">
    <h1>批量文件重命名工具</h1>
    <div class="badge">隐私保护：本地处理</div>
  </div>

  <div class="main-grid">
    
    <!-- 左侧：规则设置 -->
    <div class="card">
      <div class="card-head">
        <div>命名规则</div>
        <div class="card-head-sub">勾选启用 (一次仅限一个)</div>
      </div>
      <div class="rules-grid">
        
        <!-- 规则 3：批量序号 -->
        <div class="rule-row active" id="ruleNumber">
          <div class="switch-wrap">
            <label class="switch"><input type="checkbox" class="rule-switch" checked><span class="slider"></span></label>
          </div>
          <div class="rule-icon">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"></path></svg>
          </div>
          <div class="rule-content">
            <div class="rule-title">批量序号 / 序列生成</div>
            <div class="ctrl-group">
              <div class="input-row">
                <select id="numPos" style="width:140px">
                  <option value="replace" selected style="color:#2563eb; font-weight:bold;">替换原名</option>
                  <option value="suffix">加在结尾</option>
                  <option value="prefix">加在开头</option>
                </select>
                <div class="input-wrap" style="flex:1">
                  <span class="label-sm">连接符</span>
                  <input type="text" id="numSep" value="_" style="width:100%" placeholder="-" disabled>
                </div>
              </div>
              <div class="input-row">
                <div class="input-wrap">
                  <span class="label-sm">起始</span>
                  <input type="number" id="numStart" value="1" style="width:70px">
                </div>
                <div class="input-wrap">
                  <span class="label-sm">位数</span>
                  <input type="number" id="numDigits" value="1" min="1" max="10" style="width:60px" title="例如3位：001">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 规则 2：添加文字 -->
        <div class="rule-row" id="ruleInsert">
          <div class="switch-wrap">
            <label class="switch"><input type="checkbox" class="rule-switch"><span class="slider"></span></label>
          </div>
          <div class="rule-icon">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
          </div>
          <div class="rule-content">
            <div class="rule-title">添加文字</div>
            <div class="ctrl-group">
              <div class="input-row">
                <select id="insertPos" style="width:100px">
                  <option value="prefix">加在开头</option>
                  <option value="suffix">加在结尾</option>
                </select>
                <input type="text" id="insertText" placeholder="输入文字" style="flex:1">
              </div>
            </div>
          </div>
        </div>

        <!-- 规则 1：查找替换 -->
        <div class="rule-row" id="ruleReplace">
          <div class="switch-wrap">
            <label class="switch"><input type="checkbox" class="rule-switch"><span class="slider"></span></label>
          </div>
          <div class="rule-icon">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
          </div>
          <div class="rule-content">
            <div class="rule-title">查找与替换</div>
            <div class="ctrl-group">
              <input type="text" id="findText" placeholder="查找内容">
              <div class="input-row">
                <span style="color:#cbd5e1; font-size:16px;">➜</span>
                <input type="text" id="repText" placeholder="替换为 (留空删除)">
              </div>
              <label style="font-size:12px; display:flex; align-items:center; gap:6px; cursor:pointer; color:var(--text-sub);">
                <input type="checkbox" id="useRegex"> 使用正则
              </label>
            </div>
          </div>
        </div>

        <!-- 规则 4：扩展名小写 (隐式存在) -->
        <!-- 已移除显示，逻辑保留 -->

      </div>
    </div>

    <!-- 右侧：文件列表 & 上传 -->
    <div class="file-list-wrap card">
      <!-- 整合的上传区，放在列表上方 -->
      <div class="upload-compact" id="dropZone">
        <!-- 图标 -->
        <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
        <!-- 按钮 ID 用来精准绑定点击事件 -->
        <button class="btn-select" id="btnUploadClick">
          <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
          添加文件
        </button>
        <span class="upload-hint">支持拖拽 / 粘贴(Ctrl+V)</span>
        <input type="file" id="fileInput" multiple>
      </div>

      <div class="card-head" style="border-top:1px solid #f1f5f9; background:#fff;">
        <div style="display:flex; align-items:baseline;">
          预览列表 <span class="card-head-sub">已选 <b id="fileCount" style="color:var(--primary)">0</b> 个</span>
        </div>
        
        <!-- 操作区移动到这里 -->
        <div class="list-header-ctrls">
          <label style="font-size:12px; color:var(--text-sub); display:flex; align-items:center; gap:6px; cursor:pointer;">
            <input type="checkbox" id="autoFix" checked style="width:14px; height:14px; accent-color:var(--primary);"> 自动解决冲突
          </label>
          <button class="btn-xs" id="btnClear">清空列表</button>
        </div>
      </div>

      <div class="preview-area">
        <table id="fileTable">
          <thead>
            <tr>
              <th class="col-idx">#</th>
              <th class="col-old">原文件名</th>
              <th class="col-arrow"></th>
              <th class="col-new">新文件名预览</th>
              <th class="col-status">状态</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr>
              <td colspan="5" style="text-align:center; padding:80px 0; color:#9ca3af;">
                <div style="font-size:14px;">暂无文件，请添加</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<!-- 底部固定栏 -->
<div class="bottom-bar">
  <div class="bar-left">
    <!-- 清空了左侧 -->
  </div>
  
  <div class="bar-right">
    <button class="btn-action btn-apply" id="btnApply" disabled>
      <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
      确认修改 (应用到列表)
    </button>
    <button class="btn-action btn-zip" id="btnZip" disabled>
      <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
      打包下载 ZIP
    </button>
  </div>
</div>

<script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<script>
  // DOM Elements
  const els = {
    dropZone: document.getElementById('dropZone'),
    fileInput: document.getElementById('fileInput'),
    btnUploadClick: document.getElementById('btnUploadClick'),
    tableBody: document.getElementById('tableBody'),
    fileCount: document.getElementById('fileCount'),
    btnApply: document.getElementById('btnApply'),
    btnZip: document.getElementById('btnZip'),
    btnClear: document.getElementById('btnClear'),
    autoFix: document.getElementById('autoFix'),
    body: document.getElementById('body'),
    
    // Rules
    ruleRows: document.querySelectorAll('.rule-row'),
    
    // Inputs
    findText: document.getElementById('findText'),
    repText: document.getElementById('repText'),
    useRegex: document.getElementById('useRegex'),
    
    insertPos: document.getElementById('insertPos'),
    insertText: document.getElementById('insertText'),
    
    numPos: document.getElementById('numPos'),
    numStart: document.getElementById('numStart'),
    numDigits: document.getElementById('numDigits'),
    numSep: document.getElementById('numSep'),
  };

  // State
  let files = []; // { file, oldName, newName, status }

  // --- 初始化事件 ---
  
  // 1. 规则激活切换 (互斥模式)
  els.ruleRows.forEach(row => {
    const sw = row.querySelector('.rule-switch');
    sw.addEventListener('change', () => {
      if (sw.checked) {
        // 关闭其他规则
        els.ruleRows.forEach(otherRow => {
          if (otherRow !== row) {
            const otherSw = otherRow.querySelector('.rule-switch');
            if(otherSw.checked) {
              otherSw.checked = false;
              otherRow.classList.remove('active');
            }
          }
        });
        row.classList.add('active');
      } else {
        row.classList.remove('active');
      }
      updatePreview();
    });
  });

  // 2. 序号模式特殊处理 (禁用连接符)
  // 初始化状态
  const initNumPos = els.numPos.value === 'replace';
  els.numSep.disabled = initNumPos;
  if(initNumPos) els.numSep.style.backgroundColor = "#f3f4f6";

  els.numPos.addEventListener('change', () => {
    const isReplace = els.numPos.value === 'replace';
    els.numSep.disabled = isReplace;
    if (isReplace) els.numSep.style.backgroundColor = "#f3f4f6";
    else els.numSep.style.backgroundColor = "#fff";
    updatePreview();
  });

  // 3. 所有输入框变更触发预览
  const inputs = document.querySelectorAll('input, select');
  inputs.forEach(inp => {
    if (inp.type !== 'file') {
      inp.addEventListener('input', updatePreview);
      inp.addEventListener('change', updatePreview);
    }
  });

  // 4. 文件操作
  els.btnApply.addEventListener('click', applyChanges);
  els.btnZip.addEventListener('click', downloadZip);
  els.btnClear.addEventListener('click', clearFiles);
  
  // 修复：只给按钮绑定点击，dropZone 不绑 click
  els.btnUploadClick.addEventListener('click', (e) => {
    e.stopPropagation(); // 防止冒泡
    els.fileInput.click();
  });
  
  els.fileInput.addEventListener('change', e => addFiles(e.target.files));

  // 5. 拖拽支持
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
    document.body.addEventListener(evt, e => {
      e.preventDefault(); e.stopPropagation();
    });
  });
  
  document.body.addEventListener('dragenter', () => document.body.classList.add('dragging'));
  
  document.body.addEventListener('dragleave', (e) => {
    if (e.clientX === 0 && e.clientY === 0) document.body.classList.remove('dragging');
  });
  
  document.body.addEventListener('drop', (e) => {
    document.body.classList.remove('dragging');
    addFiles(e.dataTransfer.files);
  });

  // 6. 粘贴支持
  document.addEventListener('paste', (e) => {
    const activeEl = document.activeElement;
    if (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA') return;

    const items = e.clipboardData.items;
    const filesFound = [];
    if (items) {
      for (let i = 0; i < items.length; i++) {
        if (items[i].kind === 'file') {
          const f = items[i].getAsFile();
          if (f) filesFound.push(f);
        }
      }
    }
    
    if (filesFound.length > 0) {
      e.preventDefault();
      addFiles(filesFound);
      els.dropZone.classList.add('paste-success');
      setTimeout(() => els.dropZone.classList.remove('paste-success'), 400);
    }
  });

  // --- 核心逻辑 ---

  function addFiles(fileList) {
    if (!fileList || fileList.length === 0) return;
    const newFiles = Array.from(fileList).map(f => ({
      file: f,
      oldName: f.name,
      newName: f.name,
      status: 'waiting' 
    }));
    files = [...files, ...newFiles];
    updatePreview();
  }

  function clearFiles() {
    files = [];
    updatePreview();
  }

  function updatePreview() {
    els.btnApply.disabled = files.length === 0;
    els.btnZip.disabled = files.length === 0;
    els.fileCount.textContent = files.length;
    
    if (files.length === 0) {
      els.tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:80px 0; color:#9ca3af;">暂无文件，请添加</td></tr>`;
      return;
    }

    // 获取规则开关状态
    const rNum = document.querySelector('#ruleNumber .rule-switch').checked;
    const rRep = document.querySelector('#ruleReplace .rule-switch').checked;
    const rIns = document.querySelector('#ruleInsert .rule-switch').checked;
    const forceLowerExt = true;

    const usedNames = new Set();
    
    files.forEach((item, index) => {
      let name = item.oldName;
      let lastDot = name.lastIndexOf('.');
      let base = lastDot > -1 ? name.substring(0, lastDot) : name;
      let ext = lastDot > -1 ? name.substring(lastDot) : '';

      // 1. 批量序号 (优先级最高)
      if (rNum) {
        const start = parseInt(els.numStart.value) || 1;
        const digits = parseInt(els.numDigits.value) || 1;
        const sep = els.numSep.value;
        const pos = els.numPos.value;
        const numStr = String(start + index).padStart(digits, '0');
        
        if (pos === 'replace') {
            base = numStr; 
        } else if (pos === 'prefix') {
            base = numStr + sep + base;
        } else {
            base = base + sep + numStr;
        }
      }

      // 2. 查找替换
      if (rRep) {
        const find = els.findText.value;
        const rep = els.repText.value;
        const isRegex = els.useRegex.checked;
        if (find) {
          if (isRegex) {
            try { base = base.replace(new RegExp(find, 'g'), rep); } catch(e){}
          } else {
            base = base.split(find).join(rep);
          }
        }
      }

      // 3. 添加文字
      if (rIns) {
        const txt = els.insertText.value;
        const pos = els.insertPos.value;
        if (pos === 'prefix') base = txt + base;
        else base = base + txt;
      }

      // 4. 扩展名小写 (强制)
      if (forceLowerExt) {
        ext = ext.toLowerCase();
      }

      let newName = base + ext;
      
      // 冲突检测
      if (usedNames.has(newName.toLowerCase())) {
         item.tempStatus = 'conflict';
      } else {
         item.tempStatus = 'ok';
      }
      
      if (/[*?"<>|]/.test(newName)) item.tempStatus = 'error';

      usedNames.add(newName.toLowerCase());
      item.newName = newName;
    });

    renderTable();
  }

  function renderTable() {
    const displayList = files.slice(0, 100);
    
    els.tableBody.innerHTML = displayList.map((f, i) => {
      let statusHtml = '<span class="tag tag-wait">预览</span>';
      
      if (f.tempStatus === 'conflict') statusHtml = '<span class="tag tag-dup">⚠ 重名</span>';
      if (f.tempStatus === 'error') statusHtml = '<span class="tag tag-err">非法字符</span>';

      const isChanged = f.newName !== f.oldName;
      const newNameClass = isChanged ? 'color:var(--primary); font-weight:600' : 'color:#94a3b8';

      return `
        <tr>
          <td class="col-idx">${i+1}</td>
          <td class="col-old" title="${f.oldName}">${f.oldName}</td>
          <td class="col-arrow">➜</td>
          <td class="col-new" style="${newNameClass}" title="${f.newName}">${f.newName}</td>
          <td class="col-status">${statusHtml}</td>
        </tr>
      `;
    }).join('');
    
    if (files.length > 100) {
      els.tableBody.innerHTML += `<tr><td colspan="5" style="text-align:center; color:#94a3b8; padding:10px; font-size:12px;">... 还有 ${files.length - 100} 个文件未显示</td></tr>`;
    }
  }

  // --- 关键功能：应用修改 ---
  function applyChanges() {
    if (files.some(f => f.tempStatus === 'error')) {
        alert("存在非法字符，无法应用。请检查规则。");
        return;
    }

    const usedNames = new Set();
    const autoFix = els.autoFix.checked;
    
    files.forEach(f => {
      let name = f.newName;
      // 自动解决重名
      if (usedNames.has(name.toLowerCase())) {
        if (autoFix) {
          let counter = 1;
          const lastDot = name.lastIndexOf('.');
          let base = lastDot > -1 ? name.substring(0, lastDot) : name;
          let ext = lastDot > -1 ? name.substring(lastDot) : '';
          while (usedNames.has(`${base}(${counter})${ext}`.toLowerCase())) {
            counter++;
          }
          name = `${base}(${counter})${ext}`;
        }
      }
      usedNames.add(name.toLowerCase());
      
      // 固化名字
      f.oldName = name;
      f.newName = name; 
    });

    // 重置所有规则开关
    document.querySelectorAll('.rule-switch').forEach(sw => {
        sw.checked = false;
        sw.closest('.rule-row').classList.remove('active');
    });

    updatePreview(); 
    
    const btn = els.btnApply;
    const originText = btn.innerHTML;
    btn.innerHTML = `✔ 已应用`;
    btn.style.background = "var(--success)";
    btn.style.boxShadow = "none";
    setTimeout(() => {
        btn.innerHTML = originText;
        btn.style.background = "";
        btn.style.boxShadow = "";
    }, 1000);
  }

  async function downloadZip() {
    const zip = new JSZip();
    const folder = zip.folder("renamed_files");
    
    els.btnZip.textContent = '打包中...';
    els.btnZip.disabled = true;

    await new Promise(r => setTimeout(r, 50));

    // 打包时的最终检查
    const usedNames = new Set();
    const autoFix = els.autoFix.checked;

    files.forEach(f => {
      let name = f.newName;
      if (usedNames.has(name.toLowerCase()) && autoFix) {
          let counter = 1;
          const lastDot = name.lastIndexOf('.');
          let base = lastDot > -1 ? name.substring(0, lastDot) : name;
          let ext = lastDot > -1 ? name.substring(lastDot) : '';
          while (usedNames.has(`${base}(${counter})${ext}`.toLowerCase())) {
            counter++;
          }
          name = `${base}(${counter})${ext}`;
      }
      if (!usedNames.has(name.toLowerCase())) { 
          usedNames.add(name.toLowerCase());
          folder.file(name, f.file);
      }
    });

    const content = await zip.generateAsync({type:"blob"});
    saveAs(content, "batch_renamed.zip");
    
    els.btnZip.textContent = '打包下载 ZIP';
    els.btnZip.disabled = false;
  }

  // 初始化
  updatePreview();

</script>
</body>
</html>